#!/bin/bash
set -x

prog=`basename $0`

export LANG=C
export TERM=xterm
export TMP=/tmp

test $# -eq 0 -o "$1" == "-h" && {
	echo "$prog: usage: $prog όνομα url διάρκεια"
	exit 1
}

#url='mms://enleuko.live24.gr/enleuko877'
name="$1"
url="$2"
duration="$3"

pipe=$TMP/$prog.$$
output=$TMP/$(date +"$name @ %d-%b-%Y.mp3")

mkfifo $pipe
lame --silent -m s -q 2 -b 64 --add-id3v2 --ty $(date +%Y) --ta "$name" --tt "$(basename "$output" | sed 's/\.mp3$//')" --tn '1/1' --tg podcast $pipe "$output" &
lamepid=$!
mplayer -really-quiet -nocache -vo null -vc dummy -ao pcm:file=$pipe "$url" &
mplayerpid=$!
sleep $duration
kill $lamepid $mplayerpid
rm $pipe

mv "$output" ~/Dropbox/Public && rm -f ~/Dropbox/Public/$(date -d "7 days ago" +"$name @ %d-%b-%Y.mp3")

