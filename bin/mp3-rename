#!/bin/sh
#set -x

prog=`basename $0 .sh`

if [ $# -lt 1 ] ; then
	echo $prog: usage: $prog f01.mp3 f02.mp3...
	exit 1
fi

if test `type -t id3tool 2>&1 >/dev/null` ; then
	echo $prog: id3tool not found in PATH\; install and try again
	exit 1
fi

for i
do
	# here's a trick to get the mp3 info to env variables
	id3tool "$i" | awk '
/^Filename:/ { $0 = clear("Filename:", $0); printf "oldname=\"%s\"\n", $0 }
/^Song Title:/ { $0 = clear("Song Title:", $0); printf "title=\"%s\"\n", $0 }
/^Artist:/ { $0 = clear("Artist:", $0); printf "artist=\"%s\"\n", $0 }
/^Album:/ { $0 = clear("Album:", $0); printf "album=\"%s\"\n", $0 }
/^Track:/ { $0 = clear("Track:", $0); printf "trackno=\"%s\"\n", $0 }

function clear(patt, s) {
	sub("^" patt, "", s)
	sub(/^[[:space:]]+/, "", s)
	sub(/[[:space:]]+$/, "", s)
	return s
}' >/tmp/$prog.$$
	eval `cat /tmp/$prog.$$` && rm /tmp/$prog.$$
	test -z "$artist" -o -z "$title" && ( echo $prog: missing info for \`$i\'\; ignoring; continue )
	newname="$artist - $title.mp3"
	test "$oldname" != "$newname" &&
	mv -- "$oldname" "$artist - $title.mp3"
done

exit 0
